@model JKViewModels.AccountReceivable.CustomerTransactionCommonViewModel

@section styles{

    <link href='@Url.Content("~/Content/admin/assets/global/plugins/datatables/datatables.min.css")' rel="stylesheet" type="text/css" />
    <link href='@Url.Content("~/Content/admin/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css")' rel="stylesheet" type="text/css" />
    <style type="text/css">
        #tblcontractdetailrows {
        }

        .theadRow tr {
            font-size: 12px;
        }

        .theadRow td {
            border: 1px solid #e8e8e8 !important;
            padding: 0px 5px !important;
            font-size: 12px;
        }

        .theadRowH td {
            border-left: 1px solid #e8e8e8 !important;
            border-right: 1px solid #e8e8e8 !important;
            border-bottom: 1px solid #e8e8e8 !important;
            padding: 5px 5px !important;
            font-size: 12px;
        }

        .theadRowH.remove-padding td {
            padding: 0px !important;
            font-size: 12px;
        }

        .theadRow td > label, .theadRowH td > label {
            float: left;
            margin-top: 3px;
            font-size: 12px;
        }

        .theadRow td input[type=checkbox], .theadRowH td input[type=checkbox] {
            float: left;
            margin-right: 5px;
            margin-top: 6px;
            font-size: 12px;
        }

        .theadRow td input[type=text], .theadRowH td input[type=text] {
            margin-top: 0px !important;
            border: 0;
            border-radius: 0;
            font-size: 12px;
        }

        .theadRow td .input-sm, .theadRowH td .input-sm {
            margin-top: 0px !important;
            border: 0;
            border-radius: 0;
            font-size: 12px;
        }

        .error {
            border: 1px solid red !important;
        }

        label.error {
            display: none !important;
        }
    </style>
}


<div class="custom-form portlet light">
    <div class="headerbox">
        <div class="row">
            &nbsp;
        </div>
    </div>
    <div class="portlet-body form">
        @using (Html.BeginForm("ManualInvoice", "AccountReceivable", FormMethod.Post, new { area = "Portal", id = "form_manualinvoice_submitForm" }))
        {
            @Html.HiddenFor(m => m.CustomerId, new { id = "hdfCustomerId", required = "required" })

            <input type="hidden" id="hdftotallineno" name="hdftotallineno" />
            <input type="hidden" id="hdfftotallineno" name="hdfftotallineno" />

            <input type="hidden" id="hdfTaxRateId" name="hdfTaxRateId" />
            <input type="hidden" id="hdfContractTaxRate" name="hdfContractTaxRate" />
            <input type="hidden" id="hdfLeaseTaxRate" name="hdfLeaseTaxRate" />
            <input type="hidden" id="hdfSupplyTaxRate" name="hdfSupplyTaxRate" />

            <div class="form-body">

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label col-md-1" style="padding: 5px;">
                                Invoice For&nbsp;:
                            </label>
                            <div class="col-md-5 inline-block">
                                <input id="csearch-box" type="text" required name="customernumber" autocomplete="off" placeholder="Search Customer Name or Number" value="" class="form-control input-sm typeahead requiredValidation" />
                            </div>

                        </div>
                        <hr style="margin: 0px;" />
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <span class="control-label col-md-12" style="text-align: center;padding: 5px;background-color: #e8e8e8;margin-bottom:5px;font-weight:bold;">Customer No:  <b><span id="spncustomerno"></span></b> </span>
                            @*<label class="col-md-12"><b><span id="spncustomerno"></span></b></label>*@
                            <label class="col-md-12"><b><span id="spncustomername"></span></b></label>
                            <label class="col-md-12"><span id="spncustomeraddress"></span></label>
                            <label class="col-md-12"><span id="spncustomercity"></span>, <span id="spncustomerstate"></span>&nbsp;<span id="spncustomerpincode"></span></label>
                        </div>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label col-md-12" style="text-align: center;padding: 5px;background-color: #e8e8e8;margin-bottom:5px;font-weight:bold;">Billing</label>
                            <label class="col-md-12"><b><span id="spncustomerbname"></span></b></label>
                            <label class="col-md-12"><span id="spncustomeraddress1"></span></label>
                            <label class="col-md-12"><span id="spncustomercity1"></span>, <span id="spncustomerstate1"></span>&nbsp;<span id="spncustomerpincode1"></span></label>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <div class="table-responsive">


                                <table class="col-md-12 table" id="tblcontractdetailrows">
                                    <thead>
                                        <tr class="theadRow" style="background-color:#e8e8e8;">
                                            <td style="padding: 3px!important;">Description</td>
                                            <td colspan="5" style="padding: 0px!important;">
                                                @*<input type="text" id="txtInvoiceDescription" name="txtInvoiceDescription" value="" style="width:100%;width: 100%;padding: 4px;border-radius: 0px;" maxlength="150" />*@
                                                <textarea required="" id="txtInvoiceDescription" name="txtInvoiceDescription" class="form-control input-sm requiredValidation" row="1" style="width:100%;padding: 5px;border-radius: 0px;resize:vertical;max-height:100px;min-height:30px;"></textarea>
                                            </td>
                                            <td colspan="2" style="padding: 3px!important;text-align: right;padding-right: 10px!important;">Inv Date</td>
                                            <td style="padding: 0px!important;"><input type="text" name="txtInvoicedate" placeholder="" value="@DateTime.Now.ToString(" MM/dd/yyyy")" class="form-control input-sm date-picker" /></td>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot>
                                        <tr class="theadRowH remove-padding">
                                            <td colspan="6" rowspan="3" style="text-align:left;vertical-align:top;padding:7px;"><a href="javascript:void(0);" onclick="addNewEntry()">+ Add</a></td>
                                            <td colspan="2" style="padding:4px !important"><b>Sub Total</b></td>
                                            <td colspan="1" style="padding:0 !important"><input readonly id="txtsubtotal" type="text" name="txtsubtotal" value="" class="form-control input-sm" style="padding: 5px;border-radius: 0px;" /></td>
                                        </tr>
                                        <tr class="theadRowH remove-padding">
                                            <td colspan="2" style="padding:4px !important"><b>Tax</b></td>
                                            <td colspan="1" style="padding:0 !important"><input readonly id="txttaxamount" type="text" name="txttaxamount" value="" class="form-control input-sm" style="padding: 5px;border-radius: 0px;" /></td>
                                        </tr>
                                        <tr class="theadRowH remove-padding">
                                            <td colspan="2" style="padding:4px !important"><b>Total</b></td>
                                            <td colspan="1" style="padding:0 !important"><input readonly id="txttotalamount" type="text" name="txttotalamount" value="" class="form-control input-sm" style="padding: 5px;border-radius: 0px;" /></td>
                                        </tr>
                                    </tfoot>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <table class="col-md-12" style="border:1px solid #e8e8e8" id="frdestributionTable">
                                <thead>
                                    <tr>
                                        <th colspan="5"><input type="text" id="fsearch-box" autocomplete="off" name="name" value="" placeholder="Search Pay To by Number or Name" class="form-control input-sm typeahead" style="padding: 5px;border-radius: 0px;margin: 0px;" /></th>
                                    </tr>
                                    <tr>
                                        <th style="width:150px;padding:3px;margin: 0px;">Line No</th>
                                        <th style="width:150px;padding:3px;margin: 0px;">Franchisee No.</th>
                                        <th style="padding:3px;">Name</th>
                                        <th style="width:100px;padding:3px;">Amount</th>
                                        <th style="width:25px;padding:3px;"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions">

                <div class="col-md-12">

                    <button type="button" name="SaveNew" id="btnSaveNew" value="SaveNew" class="btn btn-primary button-next pull-right" onclick="" style="margin-right:0px;">Save & New</button>
                    <button type="button" name="SaveClose" id="btnSaveClose" value="SaveClose" class="btn btn-primary button-next pull-right" onclick="" style="margin-right:10px;">Save & Close</button>

                </div>

            </div>

        }
    </div>
</div>


@section pageplugins{
    <script src='@Url.Content("~/Content/admin/assets/global/plugins/select2/js/select2.full.min.js")' type="text/javascript"></script>
    <script src='@Url.Content("~/Content/admin/assets/global/plugins/jquery-validation/js/jquery.validate.min.js")' type="text/javascript"></script>
    <script src='@Url.Content("~/Content/admin/assets/global/plugins/jquery-validation/js/additional-methods.min.js")' type="text/javascript"></script>
    <script src='@Url.Content("~/Content/admin/assets/global/plugins/bootstrap-wizard/jquery.bootstrap.wizard.min.js")' type="text/javascript"></script>
    <script src='@Url.Content("~/Content/admin/assets/global/plugins/jquery-inputmask/jquery.inputmask.bundle.min.js")' type="text/javascript"></script>
    <script src='@Url.Content("~/Content/admin/assets/global/plugins/bootstrap-typeahead/bootstrap3-typeahead.min.js")' type="text/javascript"></script>

}
@section scripts{
    <script src='@Url.Content("~/Content/admin/assets/pages/scripts/components-date-time-pickers.min.js")' type="text/javascript"></script>
    <script>

        function ValidateInputSelect() {
            var IsValidItem = true;
            $("input.requiredValidation").each(function () {
                if ($(this).val().length == 0) {
                    $(this).addClass('error');
                    IsValidItem = false;
                }
                else {
                    $(this).removeClass('error');
                }
            });

            $("select.requiredValidation").each(function () {
                if ($(this).val() == "") {
                    $(this).addClass('error');
                    IsValidItem = false;
                }
                else {
                    $(this).removeClass('error');
                }
            });


            $("select.ddldetaillinenumber").each(function () {
                if ($(this).val() == "") {
                    $(this).addClass('error');
                    IsValidItem = false;
                }
                else {
                    $(this).removeClass('error');
                }
            });


            $("textarea.requiredValidation").each(function () {
                if ($(this).val() == "") {
                    $(this).addClass('error');
                    IsValidItem = false;
                }
                else {
                    $(this).removeClass('error');
                }
            });



            var amt = 0;
            $("input.frfranchiseeamount").each(function () {

                var tempFranchiseeAmt = parseFloat($(this).val().replace('$', '').replace(' ', '').replace(',', '') == '' ? 0 : $(this).val().replace('$', '').replace(' ', '').replace(',', ''))
                amt = amt + tempFranchiseeAmt;
            });

            var txtsubtotal = parseFloat($('#txtsubtotal').val().replace('$', '').replace(' ', '').replace(',', '') == '' ? 0 : $('#txtsubtotal').val().replace('$', '').replace(' ', '').replace(',', ''));

            if (amt != txtsubtotal) {
                IsValidItem = false;
                $(".frfranchiseeamount").addClass('error');
            }
            else {
                $(".frfranchiseeamount").removeClass('error');
            }



            return IsValidItem;


        }


        var isSaveNew = false;
        $("#form_manualinvoice_submitForm").submit(function (event) {

            //$.blockUI();
            $.ajax({
                type: "POST",
                url: $(this).attr('action'),
                data: $(this).serialize(),
                error: function (xhr, status, error) {
                    //do something about the error
                },
                success: function (response) {
                    //do something with response
                    if (isSaveNew = false)
                        window.location.href = '@Url.Action("ManualInvoice", "AccountReceivable", new { area = "Portal" })';
                    else
                        window.location.href = '@Url.Action("GenerateInvoice", "AccountReceivable", new { area = "Portal" })';
                    //alert('success')
                    $.unblockUI();
                }
            });
            $.unblockUI();

            //return false;// if it's a link to prevent post
            event.preventDefault();
        });

        $("#btnSaveNew").click(function () {

            if (!ValidateInputSelect())
                return false;

            var isValid = $("#form_manualinvoice_submitForm").valid();
            if (isValid) {
                $("#form_manualinvoice_submitForm").submit();
                isSaveNew = true;
            }
        });
        $("#btnSaveClose").click(function () {

            if (!ValidateInputSelect())
                return false;

            var isValid = $("#form_manualinvoice_submitForm").valid();
            if (isValid) {
                $("#form_manualinvoice_submitForm").submit();

            }
        });

        var lstContractDetailServiceTypeList = [];
        var lineNo = 0;
        var flineNo = 0;

        var app = {};

        (function (app) {

            var _id;

            app.init = function (id) {
                if (id != '') {
                    _id = id;
                    $("#hdfCustomerId").val(_id);
                    bindcustomerdetail(_id);

                    if ($("#hdfCustomerId").val() != '') {
                        $('#csearch-box').prop('required', false);
                    }
                }
            }

        })(app);

        $(document).ready(function () {

            $('input').on("keypress", function (e) {

                $("input.unitPrice").each(function () {
                    if ($(this).val() != "") {
                        $(this).removeClass('error');
                    }
                });

                $("select.ContractDetailServiceTypeList").each(function () {
                    if ($(this).val() != "") {
                        $(this).removeClass('error');
                    }
                });

                /* ENTER PRESSED*/
                if (e.keyCode == 13) {
                    /* FOCUS ELEMENT */
                    var inputs = $(this).parents("form").eq(0).find(":input");
                    var idx = inputs.index(this);

                    if (idx == inputs.length - 1) {
                        inputs[0].select()
                    } else {
                        inputs[idx + 1].focus(); //  handles submit buttons
                        inputs[idx + 1].select();
                    }



                    return false;
                }
            });

            app.init('@ViewContext.RouteData.Values["id"]');

            onlyDecimal("#txtCommissionAmount");


            $("#hdftotallineno").val(lineNo);
            $("#hdfftotallineno").val(flineNo);
            $('#txtInvoicedate').inputmask("mm/dd/yyyy", {});
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetContractDetailServiceTypeList", "AccountReceivable", new { area = "Portal" })',
                success: function (data) {
                    lstContractDetailServiceTypeList = data;
                    addNewEntry();
                }
            })
            $("#csearch-box").keyup(function () {
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("Customerdata", "AccountReceivable", new { area = "Portal" })',
                    data: 'keyword=' + $(this).val(),
                    //beforeSend: function () {
                    //    $("#csearch-box").css("background", "#FFF url(LoaderIcon.gif) no-repeat 165px");
                    //},
                    success: function (data) {
                        var typeaheadSource = [];
                        $.each(data, function (key, value) {
                            typeaheadSource.push({ id: value.CustomerId, name: value.CustomerNo + ' ' + $.trim(value.Name) })
                        });

                        $('#csearch-box').typeahead({
                            source: typeaheadSource,
                            updater: function (item) {
                                console.log(item);
                                $("#hdfCustomerId").val(item.id);

                                $("#frdestributionTable tbody").empty();
                                flineNo = 0;
                                bindcustomerdetail(item.id);
                                return item;
                            }
                        }).focus();
                    }
                });


                $("#ContractDetail_Amount").inputmask("numeric", {
                    decimal: ".",
                    negative: false,
                    scale: 2,
                    groupSeparator: ",",
                    digits: 2,
                    autoGroup: true,
                    prefix: "$",
                    rightAlign: false,
                    autoUnmask: true,
                    removeMaskOnSubmit: true,
                });

                $('.cnumeric').inputmask("numeric", { negative: false, scale: 2, rightAlign: false, autoUnmask: true, removeMaskOnSubmit: true, });

            });


            $("#fsearch-box").keyup(function () {
                $.ajax({
                    type: "GET",
                    url: '@Url.Action("Frenchiseedata", "AccountReceivable", new { area = "Portal" })',
                    data: 'keyword=' + $(this).val(),
                    success: function (data) {
                        custlist = data;
                        var typeaheadSource = [];
                        $.each(custlist, function (key, value) {
                            typeaheadSource.push({ id: value.FranchiseeId, name: value.FranchiseeNo + '   ' + $.trim(value.Name) })
                        });

                        $('#fsearch-box').typeahead({
                            source: typeaheadSource,
                            updater: function (item) {
                                $("#hdfFrenchiseeId").val(item.id);
                                console.log(item.name);
                                bindfranchiseedetailUpdated(item.id, $.trim(item.name.split('   ')[0]), $.trim(item.name.split('   ')[1]));

                                return item;
                            }
                        });
                    }
                });
            });
        });

        function bindcustomerdetail(customerid) {
            $.ajax({
                type: "GET",
                url: '@Url.Action("CustomerDetaildata", "AccountReceivable", new { area = "Portal" })',
                data: 'customerid=' + customerid,
                success: function (data) {
                    $("#spncustomerno").text($.trim(data.CustomerNo));
                    $("#spncustomername").text($.trim(data.Name));
                    $("#spncustomeraddress").text($.trim(data.Address1));
                    $("#spncustomercity").text($.trim(data.City))
                    $("#spncustomerstate").text($.trim(data.StateName));
                    $("#spncustomerpincode").text($.trim(data.PostalCode));


                    $("#spncustomerbname").text($.trim(data.BName));
                    $("#spncustomerbattname").text($.trim(data.Attention));
                    $("#spncustomeraddress1").text($.trim(data.BAddress1));
                    $("#spncustomercity1").text($.trim(data.BCity))
                    $("#spncustomerstate1").text($.trim(data.BStateName));
                    $("#spncustomerpincode1").text($.trim(data.PostalCode));

                    $("#hdfTaxRateId").val(data.TaxRateId);
                    $("#hdfContractTaxRate").val(data.ContractTaxRate);
                    $("#hdfLeaseTaxRate").val(data.LeaseTaxRate);
                    $("#hdfSupplyTaxRate").val(data.SupplyTaxRate);

                    bindcCustomerDistributionDetailFranchiseedetail(customerid);
                }
            });
        }


        function bindfranchiseedetailUpdated(franchiseeid, franchiseeno, franchiseename) {

            flineNo++;



            var linenumber = 0;
            var txttotal = ''
            var lineTotalAmount = 0;

            var tempRow = '<tr id=row_' + flineNo + '><td>'
            tempRow = tempRow + '<input relLine="' + flineNo + '" type="hidden" id="hdfFrenchiseeId' + flineNo + '" name="hdfFrenchiseeId' + flineNo + '" value="' + franchiseeid + '" />'
            tempRow = tempRow + '<select relLine="' + flineNo + '"  relddldetaillinenum="ddldetaillinenumber" class="form-control input-sm ddldetaillinenumber" style="border-radius: 0px;" id="ddldetaillinenumber' + flineNo + '" name="ddldetaillinenumber' + flineNo + '"></select>';
            tempRow = tempRow + '</td>'
            tempRow = tempRow + '<td><input type="text" required relLine="' + flineNo + '" id="frfranchiseeno' + flineNo + '" name="frfranchiseeno' + flineNo + '" value="' + $.trim(franchiseeno) + '" readonly class="form-control input-sm cnumeric" style="padding: 5px;border-radius: 0px;" /></td>'
            tempRow = tempRow + '<td><input type="text" required relLine="' + flineNo + '" id="frfranchiseename' + flineNo + '" name="frfranchiseename' + flineNo + '" value="' + $.trim(franchiseename) + '" readonly class="form-control input-sm cnumeric" style="padding: 5px;border-radius: 0px;" /></td>'
            tempRow = tempRow + '<td><input type="text" relLine="' + flineNo + '" id="frfranchiseeamount' + flineNo + '" name="frfranchiseeamount' + flineNo + '" value="' + txttotal + '" class="form-control input-sm cnumeric requiredValidation frfranchiseeamount" style="padding: 5px;border-radius: 0px;" /></td>';
            tempRow = tempRow + '<td><a style="font-size: 16px;padding: 3px;color: mediumvioletred;" href="javascript:deleteFrenchisee(' + flineNo + ');"><i class="fa fa-trash" aria-hidden="true"></i></a></td></tr>';


            $('#frdestributionTable tbody').append(tempRow);
            applyMaskCurrency('#frfranchiseeamount' + flineNo);
            $("#hdfftotallineno").val(flineNo);

            var lineitems = []; lineitems.push("<option value=''>Select</option>");
            for (var i = 1; i <= lineNo; i++) { lineitems.push("<option value=" + i + ">" + i + "</option>"); }
            $('#ddldetaillinenumber' + flineNo).html('');
            $('#ddldetaillinenumber' + flineNo).html(lineitems.join(' '));


            $('#ddldetaillinenumber' + flineNo).change(function (event) {

                var fln = $(this).attr("relLine");
                if ($(this).attr("relLine") != "Select") {

                    $('#frfranchiseeamount' + fln).prop("required", true);
                }
                else {
                    $('#frfranchiseeamount' + fln).prop("required", false);
                }
            });

            setTimeout(function () {
                $("#hdfFrenchiseeId").val(0);
                $('#fsearch-box').val('');
            }, 500);

        }




        function bindcCustomerDistributionDetailFranchiseedetail(customerid) {
            $.ajax({
                type: "GET",
                url: '@Url.Action("CustomerDistributionDetailFranchiseedata", "AccountReceivable", new { area = "Portal" })',
                data: 'customerid=' + customerid,
                success: function (data) {
                    $.each(data, function () {
                        bindfranchiseedetailUpdated(this.FranchiseeId, this.FranchiseeNo, this.Name);
                    });

                }
            });
        }

        function deleteFrenchisee(flineNo) {
            $("tr[id=row_" + flineNo + "]").remove();
        }

        function bindfranchiseedetail(linenumber, franchiseeid, franchiseename) {
            flineNo++;


            //var txtmarkup = parseFloat($('#txtmarkup' + linenumber).val() == '' ? 0 : $('#txtmarkup' + linenumber).val())
            var txtqty = parseFloat($('#txtqty' + linenumber).val() == '' ? 0 : $('#txtqty' + linenumber).val())
            var txtunitprice = parseFloat($('#txtunitprice' + linenumber).inputmask('unmaskedvalue') == '' ? 0 : $('#txtunitprice' + linenumber).inputmask('unmaskedvalue'))
            var txttotal = (txtqty * txtunitprice)

            var lineTotalAmount = 0;
            $('input[relLinea="' + linenumber + '"]').each(function (el) {
                lineTotalAmount += parseFloat(this.defaultValue);
            });

            if (lineTotalAmount + txttotal > txttotal) {
                if (lineTotalAmount < txttotal) {
                    txttotal = txttotal - lineTotalAmount;
                }
                else {
                    txttotal = 0;
                }
            }



            var tempRow = '<tr id=row_' + flineNo + '><td><input type="hidden" relLine="' + linenumber + '" id="hdfFrenchiseeId' + flineNo + '_' + linenumber + '" name="hdfFrenchiseeId' + flineNo + '_' + linenumber + '" value="' + franchiseeid + '" /><input type="text" readonly id="frlinenumber' + flineNo + '_' + linenumber + '" name="frlinenumber' + flineNo + '_' + linenumber + '" value="' + linenumber + '" class="form-control input-sm cnumeric" style="padding: 5px;border-radius: 0px;" /></td>'
            tempRow = tempRow + '<td><input type="text" required relLine="' + linenumber + '" readonly id="frfranchiseeno' + flineNo + '_' + linenumber + '" name="frfranchiseeno' + flineNo + '_' + linenumber + '" value="' + $.trim(franchiseename.split('   ')[0]) + '" class="form-control input-sm cnumeric" style="padding: 5px;border-radius: 0px;" /></td>'
            tempRow = tempRow + '<td><input type="text" required relLine="' + linenumber + '" readonly id="frfranchiseename' + flineNo + '_' + linenumber + '" name="frfranchiseename' + flineNo + '_' + linenumber + '" value="' + $.trim(franchiseename.split('   ')[1]) + '" class="form-control input-sm cnumeric" style="padding: 5px;border-radius: 0px;" /></td>'
            tempRow = tempRow + '<td><input type="text" required relLine="' + linenumber + '"  relLinea="' + linenumber + '" id="frfranchiseeamount' + flineNo + '_' + linenumber + '" name="frfranchiseeamount' + flineNo + '_' + linenumber + '" value="' + txttotal + '" class="form-control input-sm cnumeric requiredValidation" style="padding: 5px;border-radius: 0px;" /></td>';
            tempRow = tempRow + '<td><a style="font-size: 16px;padding: 3px;color: mediumvioletred;" href="javascript:deleteFrenchisee(' + linenumber + ',' + flineNo + ');"><i class="fa fa-trash" aria-hidden="true"></i></a></td></tr>';



            $('#frdestributionTable tbody').append(tempRow);
            applyMaskCurrency('#frfranchiseeamount' + flineNo + '_' + linenumber);
            $("#hdfftotallineno").val(flineNo);


            setTimeout(function () {
                $("#hdfFrenchiseeId").val(0);
                //document.getElementById('ddldetaillinenumber').selectedIndex = 0;
                $('#fsearch-box').val('');
            }, 500);

        }
        $('#fsearch-box').keypress(function (event) {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if (keycode == '13') {
                $(this).typeahead('val', '');
            }
        });

        function addNewEntry() {

            var ItemValid = true;

            $("input.unitPrice").each(function () {
                if ($(this).val().length == 0 || $(this).val() == "0") {
                    $(this).addClass('error');
                    ItemValid = false;
                }
                else {
                    $(this).removeClass('error');
                }
            });

            $("select.ContractDetailServiceTypeList").each(function () {
                if ($(this).val().length == 0 || $(this).val() == "0") {
                    $(this).addClass('error');
                    ItemValid = false;
                }
                else {
                    $(this).removeClass('error');
                }
            });

            if (!ItemValid)
                return false;

            lineNo++;

            var tr = "";
            tr = tr + '<tr relline="S' + lineNo + '" style="background-color:#eef1f5;border-right: 1px solid #eef1f5;">';
            tr = tr + '<td colspan="9" style="padding:0!important;">';
            tr = tr + '<table class="col-md-12" style="margin: 0px!important;">';
            tr = tr + '<tr class="theadRow">';
            tr = tr + '<td style="width:72px;padding: 0px !important;text-align:center;">Line No</td>';
            tr = tr + '<td></td>';
            tr = tr + '<td style="width: 110px;"><input type="checkbox" id="chkCommission' + lineNo + '" name="chkCommission' + lineNo + '"><label>Commission</label></td>';
            tr = tr + '<td style="width: 110px;padding: 0 0px !important;"><input type="text" id="txtCommissionAmount' + lineNo + '" name="txtCommissionAmount' + lineNo + '" value="0" maxlength="10" class="form-control input-sm" /></td>';
            tr = tr + '<td style="width: 105px;"><input type="checkbox" id="chkExtraWork' + lineNo + '" name="chkExtraWork' + lineNo + '"><label for="chkExtraWork' + lineNo + '" style="padding-left: 0px;">Extra Work</label></td>';
            tr = tr + '<td style="width: 115px;"><input type="checkbox" id="chkTaxExcempt' + lineNo + '" name="chkTaxExcempt' + lineNo + '"><label for="chkTaxExcempt' + lineNo + '" style="padding-left: 0px;">Tax Exempt</label></td>';
            tr = tr + '<td style="width: 105px;"><input type="checkbox" id="chkBPPAdmin' + lineNo + '" name="chkBPPAdmin' + lineNo + '"><label for="chkBPPAdmin' + lineNo + '" style="padding-left: 0px;">BPP Admin</label></td>';
            tr = tr + '<td style="width: 115px;"><input type="checkbox" id="chkAcctRebate' + lineNo + '" name="chkAcctRebate' + lineNo + '" /><label for="chkAcctRebate' + lineNo + '" style="padding-left: 0px;">Acct Rebate</label></td>';
            tr = tr + '</tr>';
            tr = tr + '</table>';
            tr = tr + '</td>';
            tr = tr + '</tr>';


            $('#tblcontractdetailrows>tbody').append(tr);
            tr = "";
            tr = tr + '<tr relline="S' + lineNo + '" class="theadRowH" style="background-color:#eef1f5;">';
            tr = tr + '<td style="text-align:center;width:60px;padding: 0px !important;"><input type="text" readonly="" id="txtlinenumber' + lineNo + '" name="txtlinenumber' + lineNo + '" value="' + lineNo + '" class="form-control input-sm cnumeric" style="text-align:center;"></td>';
            tr = tr + '<td style="text-align:center;width:150px;">Service</td>';
            tr = tr + '<td style="text-align:center;">Detail Description</td>';
            tr = tr + '<td style="width:60px;text-align:center;">MarkUp</td>';
            tr = tr + '<td style="width:60px;text-align:center;">Qty</td>';
            tr = tr + '<td style="width:100px;text-align:center;">Unit Price</td>';
            tr = tr + '<td style="width:100px;text-align:center;">Extended Price</td>';
            tr = tr + '<td style="width:50px;text-align:center;">Tax</td>';
            tr = tr + '<td style="width:100px;text-align:center;">Total</td>';
            tr = tr + '</tr>';


            $('#tblcontractdetailrows>tbody').append(tr);
            tr = "";
            tr = tr + '<tr relline="S' + lineNo + '" class="theadRowH remove-padding">';
            tr = tr + '<td style="background-color:#eef1f5;"></td>';
            tr = tr + '<td><select class="form-control input-sm requiredValidation ContractDetailServiceTypeList" id="ContractDetailServiceTypeList' + lineNo + '" name="ContractDetailServiceTypeList' + lineNo + '" ></select></td>';
            tr = tr + '<td><textarea required="" id="txtdescription' + lineNo + '" name="txtdescription' + lineNo + '" class="form-control input-sm requiredValidation" row="1" style="padding: 5px;border-radius: 0px;resize:vertical;max-height:100px;min-height:30px;"></textarea></td>';

            tr = tr + '<td><input type="text" required="" onchange="CalculateAmount(' + lineNo + ')" id="txtmarkup' + lineNo + '" name="txtmarkup' + lineNo + '" value="0" class="form-control input-sm" style="padding: 5px;border-radius: 0px;" ></td>';
            tr = tr + '<td><input type="text" required="" onchange="CalculateAmount(' + lineNo + ')" id="txtqty' + lineNo + '" name="txtqty' + lineNo + '" value="1" class="form-control input-sm" style="padding: 5px;border-radius: 0px;"></td>';
            tr = tr + '<td><input type="hidden" id="hdfunitprice' + lineNo + '" name="hdfunitprice' + lineNo + '"/>'
            tr = tr + '<input type="text" required="" onblur="CalculateAmount(' + lineNo + ')" id="txtunitprice' + lineNo + '" name="txtunitprice' + lineNo + '" value="" class="form-control input-sm requiredValidation unitPrice" style="padding: 5px;border-radius: 0px;"></td>';
            tr = tr + '<td><input type="text" required="" readonly="" onchange="CalculateAmount(' + lineNo + ')" id="txtExtendedPrice' + lineNo + '" name="txtExtendedPrice' + lineNo + '" value="" class="form-control input-sm" style="padding: 5px;border-radius: 0px;"></td>';
            tr = tr + '<td><input type="text" required="" readonly="" onchange="CalculateAmount(' + lineNo + ')" id="txttax' + lineNo + '" name="txttax' + lineNo + '" value="" class="form-control input-sm" style="padding: 5px;border-radius: 0px;"></td>';
            tr = tr + '<td><input type="text" required="" readonly="" onchange="CalculateAmount(' + lineNo + ')" id="txttotal' + lineNo + '" name="txttotal' + lineNo + '" value="" class="form-control input-sm" style="padding: 5px;border-radius: 0px;"></td>';
            tr = tr + '</tr>';

            $('#tblcontractdetailrows>tbody').append(tr);
            applyMaskCurrency('#txtunitprice' + lineNo);
            applyMaskCurrency('#txttax' + lineNo);
            applyMaskCurrency('#txttotal' + lineNo);
            applyTaxExcempt(lineNo)
            applyCommission(lineNo)

            var items = [];
            items.push("<option value=''>Select</option>");
            $.each(lstContractDetailServiceTypeList, function () {
                items.push("<option value=" + this.ContractDetailServiceTypeListId + ">" + this.Name + "</option>");
            });
            $('#ContractDetailServiceTypeList' + lineNo).html(items.join(' '));


            ContractDetailServiceTypeListOnChange('ContractDetailServiceTypeList' + lineNo, lineNo);

            //$('#txtunitprice' + lineNo).keyup(function () {
            //    $('#hdfunitprice' + lineNo).val($('#txtunitprice' + lineNo).val());
            //});

            $('.unitPrice').keyup(function () {
                var fieldId = $(this).attr('id');
                fieldId = fieldId.replace('txtunitprice', '');
                //unitPrice
                $('#hdfunitprice' + fieldId).val($('#txtunitprice' + fieldId).val());
            });


            //$('#ddldetaillinenumber').html('');
            var lineitems = []; lineitems.push("<option value=''>Select</option>");
            for (var i = 1; i <= lineNo; i++) { lineitems.push("<option value=" + i + ">" + i + "</option>"); }
            //$('#ddldetaillinenumber').html(lineitems.join(' '));


            $('select[relddldetaillinenum="ddldetaillinenumber" ]').each(function (item) {

                $(this).html('');
                $(this).html(lineitems.join(' '));

            });


            $("#hdftotallineno").val(lineNo);
            OnlyNumber('#txtmarkup' + lineNo)
            OnlyNumber('#txtqtycc' + lineNo)
            onlyDecimal('#txtunitprice' + lineNo)


        }
        function CalculateAmount(ln) {

            var temptax = parseFloat($("#hdfContractTaxRate").val());
            var txtmarkup = parseFloat($('#txtmarkup' + ln).val() == '' ? 0 : $('#txtmarkup' + ln).val())

            var txtunitpriceT = parseFloat($('#hdfunitprice' + ln).inputmask('unmaskedvalue').replace('$', '').replace(' ', '').replace(',', '') == '' ? 0 : $('#hdfunitprice' + ln).inputmask('unmaskedvalue').replace('$', '').replace(' ', '').replace(',', ''));

            var txtqty = parseFloat($('#txtqty' + ln).val() == '' ? 0 : $('#txtqty' + ln).val())
            var txtunitprice = (txtunitpriceT + (txtunitpriceT * txtmarkup / 100));
            var txttax = $('#txttax' + ln)
            var txttotal = $('#txttotal' + ln)
            var txtExtetotal = 0;

            $('#txtunitprice' + ln).val(txtunitprice);
            txtExtetotal = (txtunitprice * txtqty);
            //txtExtetotal = ((txtunitprice + (txtunitprice * txtmarkup / 100)) * txtqty);
            $('#txtExtendedPrice' + ln).val(txtExtetotal);
            if ($('#chkTaxExcempt' + ln).is(":checked")) {
                txttax.val(0);
            }
            else {
                txttax.val((txtunitprice * txtqty) * temptax / 100)
            }

            txttotal.val((txtqty * txtunitprice) + parseFloat(txttax.inputmask('unmaskedvalue')))

            var toAmt = 0;
            var toTaxAmt = 0;
            for (var i = 1; i <= lineNo; i++) {

                toTaxAmt = toTaxAmt + parseFloat($('#txttax' + i).inputmask('unmaskedvalue') == '' ? 0 : $('#txttax' + i).inputmask('unmaskedvalue'));
                toAmt = toAmt + parseFloat($('#txttotal' + i).inputmask('unmaskedvalue') == '' ? 0 : $('#txttotal' + i).inputmask('unmaskedvalue'));
            }
            $('#txtsubtotal').val(toAmt - toTaxAmt)
            $('#txttaxamount').val(toTaxAmt)
            $('#txttotalamount').val(toAmt)

            applyMaskCurrency('#txtsubtotal');
            applyMaskCurrency('#txttaxamount');
            applyMaskCurrency('#txttotalamount');
        };
        function applyCommission(id) {
            $('#txtCommissionAmount' + id).hide();
            $('#chkCommission' + id).change(function () {
                if ($(this).is(":checked")) {
                    $('#txtCommissionAmount' + id).show();
                }
                else {
                    $('#txtCommissionAmount' + id).val("0");
                    $('#txtCommissionAmount' + id).hide();
                }
            });
        }

        function ContractDetailServiceTypeListOnChange(id, line) {
            $('#' + id).change(function () {

                if (this.value == 5) {
                    $('#txtmarkup' + line).prop("readonly", false);
                    $('#txtmarkup' + line).val(0);
                }
                else {
                    $('#txtmarkup' + line).prop("readonly", true);
                    $('#txtmarkup' + line).val(0);
                }
                CalculateAmount(line);
            });
        }

        function applyTaxExcempt(id) {
            $('#chkTaxExcempt' + id).change(function () { CalculateAmount(id); });
        }
        function onlyDecimal(id) {
            $(id).keydown(function (event) {
                if (event.shiftKey == true) { event.preventDefault(); }
                if ((event.keyCode >= 48 && event.keyCode <= 57) || (event.keyCode >= 96 && event.keyCode <= 105) || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 37 || event.keyCode == 39 || event.keyCode == 46 || event.keyCode == 190 || event.keyCode == 110) { }
                else { event.preventDefault(); }
                if ($(this).val().indexOf('.') !== -1 && (event.keyCode == 190 || event.keyCode == 110)) event.preventDefault();
            });
        }
        function OnlyNumber(id) {
            $(id).keydown(function (event) {
                if (event.shiftKey == true) { event.preventDefault(); }
                if ((event.keyCode >= 48 && event.keyCode <= 57) || (event.keyCode >= 96 && event.keyCode <= 105) || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 37 || event.keyCode == 39 || event.keyCode == 46) { }
                else { event.preventDefault(); }
            });
        }
        function applyMaskCurrency(id) {
            $(id).inputmask("currency", {
                alias: 'currency',
                prefix: '$ ',
                digits: 2,
                autoUnmask: true,
                removeMaskOnSubmit: true,
                unmaskAsNumber: true,
                allowPlus: false,
                allowMinus: false,
                autoGroup: true,
                groupSeparator: ",",
            });
        }


    </script>
}